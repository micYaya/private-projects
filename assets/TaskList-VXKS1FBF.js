import{f as H,h as R,u as le,v as ne,w as ae,y as se,z as oe,A as ie,s as E}from"./vue-core-C2r4m7CJ.js";import{ref as m,createElementBlock as N,createCommentVNode as re,openBlock as K,withModifiers as de,createElementVNode as o,createVNode as l,withCtx as s,createTextVNode as i,onMounted as ue,withKeys as ce,toDisplayString as S}from"vue";import{_ as j,c as me,h as ve,i as $,j as z,u as V,k as D,p as pe}from"./index-DjiLuGwl.js";import{ElMessage as x,ElMessageBox as L}from"element-plus";const fe={class:"modal"},_e={class:"modal-content"},ye={class:"form-item"},we={class:"modal-footer"},ge={__name:"AddTask",props:{isAddVisible:{type:Boolean,default:!1}},emits:["close","refresh"],setup(B,{emit:w}){const d=w,_=()=>{d("close")},r=m({deviceId:"",startTime:null,endTime:null,status:"未开始"}),y=()=>{r.value={deviceId:"",startTime:null,endTime:null,status:"未开始"}},g=async()=>{try{const v=await me(r.value.deviceId);if(v.error){x.error(v.error);return}const n=await ve(r.value);n&&!n.error?(x.success("任务创建成功"),y(),_(),d("refresh")):x.error("任务创建失败，请检查参数")}catch(v){console.error("保存任务失败",v),x.error("保存任务失败，请稍后重试")}};return(v,n)=>{const T=H,I=R;return B.isAddVisible?(K(),N("div",{key:0,class:"modal-overlay",style:{"z-index":"99"},onClick:de(_,["self"])},[o("div",fe,[o("div",{class:"modal-header"},[n[1]||(n[1]=o("span",null,"添加任务",-1)),o("button",{onClick:_},"×")]),o("div",_e,[o("form",null,[o("div",ye,[n[2]||(n[2]=o("label",null,"*设备编号",-1)),l(T,{modelValue:r.value.deviceId,"onUpdate:modelValue":n[0]||(n[0]=k=>r.value.deviceId=k),placeholder:"请输入设备编号",style:{width:"300px"}},null,8,["modelValue"])])])]),o("div",we,[l(I,{type:"primary",disabled:!r.value.deviceId,onClick:g},{default:s(()=>n[3]||(n[3]=[i(" 保存 ")])),_:1},8,["disabled"]),l(I,{onClick:y},{default:s(()=>n[4]||(n[4]=[i(" 重置 ")])),_:1})])])])):re("",!0)}}},Te=j(ge,[["__scopeId","data-v-fe78fa00"]]),he={class:"list-container"},be={class:"upper-section"},Ie={class:"search-filter"},ke={class:"action-buttons"},Ce={class:"lower-section"},xe={class:"pagination-wrapper"},Ee={__name:"TaskList",setup(B){const w=m([]),d=m([]),_=m(""),r=m(1),y=m(5),g=m(0),v=m([]),n=m(!1),T=m(!1),I=le(),k=e=>e?E(new Date(e),"yyyy-MM-dd HH:mm:ss"):"",h=async()=>{try{w.value=await $(),g.value=w.value.length,C()}catch(e){console.error("获取任务列表失败",e)}},C=()=>{const e=(r.value-1)*y.value,t=e+y.value;d.value=w.value.slice(e,t)},P=e=>{y.value=e,r.value=1,C()},U=e=>{r.value=e,C()},q=()=>{T.value=!0},F=(e,t,u)=>{I.push({name:"item-info",params:{taskId:e},query:{deviceId:t,status:u}})},O=e=>{L.confirm(`是否确定对设备编号为 ${e.deviceId} 发起实验？`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{W(e)}).catch(()=>{})},W=async e=>{try{const u=E(new Date,"yyyy-MM-dd HH:mm:ss");await D(e.id,{deviceId:e.deviceId,startTime:u,endTime:null,status:"实验中"});const b=d.value.findIndex(p=>p.id===e.id);b!==-1&&(d.value[b].startTime=u,d.value[b].status="实验中");for(let p=0;p<e.item_count;p++){console.log(p);const c=await pe(e.deviceId);console.log(c)}setTimeout(async()=>{const c=E(new Date,"yyyy-MM-dd HH:mm:ss");await D(e.id,{deviceId:e.deviceId,startTime:e.startTime,endTime:c,status:"已完成"}),await V(e.deviceId,"检测完成"),await h()},5e3)}catch(t){console.error("发起实验失败",t)}},G=e=>{v.value=e,n.value=e.length>0&&e.length<d.value.length,e.length===d.value.length&&(n.value=!1)},J=e=>{e.length===d.value.length?n.value=!1:e.length>0?n.value=!0:n.value=!1,v.value=e},Q=()=>!0,M=async()=>{try{const t=(await $()).filter(u=>u.deviceId.includes(_.value));w.value=t,g.value=t.length,r.value=1,C()}catch(e){console.error("搜索任务信息失败",e)}},X=async()=>{try{for(const e of v.value)await z(e.id),await V(e.deviceId,"未检测");await h()}catch(e){console.error("批量删除任务信息失败",e)}},Y=async e=>{try{await z(e.id),await V(e.deviceId,"未检测"),await h()}catch(t){console.error("删除任务信息失败",t)}},Z=e=>{L.confirm("请问您是否要删除该任务信息?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Y(e)}).catch(()=>{})};return ue(()=>{h()}),(e,t)=>{const u=ae,b=ne,p=H,c=R,f=oe,ee=se,te=ie;return K(),N("div",he,[l(b,{separator:"/",class:"breadcrumb"},{default:s(()=>[l(u,null,{default:s(()=>t[2]||(t[2]=[i("首页")])),_:1}),l(u,null,{default:s(()=>t[3]||(t[3]=[i("实验任务管理")])),_:1}),l(u,null,{default:s(()=>t[4]||(t[4]=[i("任务管理")])),_:1})]),_:1}),o("div",be,[o("div",Ie,[l(p,{modelValue:_.value,"onUpdate:modelValue":t[0]||(t[0]=a=>_.value=a),placeholder:"请输入设备编号",style:{width:"250px",margin:"10px 0"},onKeyup:ce(M,["enter"])},null,8,["modelValue"]),l(c,{type:"primary",onClick:M},{default:s(()=>t[5]||(t[5]=[i(" 搜索 ")])),_:1})]),o("div",ke,[l(c,{type:"danger",onClick:X},{default:s(()=>t[6]||(t[6]=[i(" 批量删除 ")])),_:1}),l(c,{type:"warning",onClick:q},{default:s(()=>t[7]||(t[7]=[i(" 添加任务 ")])),_:1})])]),t[11]||(t[11]=o("br",null,null,-1)),o("div",Ce,[l(ee,{data:d.value,border:"",style:{width:"100%","margin-top":"20px"},"cell-style":{textAlign:"center"},"header-cell-style":{textAlign:"center"},onSelectionChange:G},{default:s(()=>[l(f,{type:"selection",width:"50",indeterminate:n.value,selectable:Q,onSelectAll:J},null,8,["indeterminate"]),l(f,{prop:"id",label:"任务ID",width:"100"}),l(f,{prop:"deviceId",label:"设备编号",width:"100"}),l(f,{prop:"status",label:"实验状态",width:"100"}),l(f,{prop:"startTime",label:"开始时间",width:"200"},{default:s(a=>[i(S(a.row.startTime?k(a.row.startTime):""),1)]),_:1}),l(f,{prop:"endTime",label:"结束时间",width:"200"},{default:s(a=>[i(S(a.row.endTime?k(a.row.endTime):""),1)]),_:1}),l(f,{prop:"item_count",label:"实验项目数量",width:"200"}),l(f,{label:"操作",fixed:"right","min-width":"400"},{default:s(a=>[l(c,{type:"primary",onClick:A=>F(a.row.id,a.row.deviceId,a.row.status)},{default:s(()=>t[8]||(t[8]=[i(" 实验项目管理 ")])),_:2},1032,["onClick"]),l(c,{type:"warning",disabled:a.row.status==="已完成"||a.row.item_count===0,onClick:A=>O(a.row)},{default:s(()=>t[9]||(t[9]=[i(" 发起实验 ")])),_:2},1032,["disabled","onClick"]),l(c,{type:"danger",onClick:A=>Z(a.row)},{default:s(()=>t[10]||(t[10]=[i(" 删除任务 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),o("div",xe,[l(te,{"current-page":r.value,"page-sizes":[5,10,15],"page-size":y.value,layout:"total, prev, pager, next, sizes, jumper",total:g.value,onSizeChange:P,onCurrentChange:U},null,8,["current-page","page-size","total"])])]),l(Te,{"is-add-visible":T.value,onClose:t[1]||(t[1]=a=>T.value=!1),onRefresh:h},null,8,["is-add-visible"])])}}},Se=j(Ee,[["__scopeId","data-v-22fba84a"]]);export{Se as default};
