import{u as q,f as y}from"./vue-core-C_l77I1y.js";import{_ as I,c as F,h as O,i as b,j as E,u as N,k,p as W}from"./index-CgfAAbnT.js";import"vue";const G={class:"modal"},J={class:"modal-content"},Q={class:"form-item"},X={class:"modal-footer"},Y={__name:"AddTask",props:{isAddVisible:{type:Boolean,default:!1}},emits:["close","refresh"],setup(x,{emit:m}){const l=m,c=()=>{l("close")},a=Vue.ref({deviceId:"",startTime:null,endTime:null,status:"未开始"}),V=()=>{a.value={deviceId:"",startTime:null,endTime:null,status:"未开始"}},p=async()=>{try{const u=await F(a.value.deviceId);if(u.error){ElementPlus.ElMessage.error(u.error);return}const o=await O(a.value);o&&!o.error?(ElementPlus.ElMessage.success("任务创建成功"),V(),c(),l("refresh")):ElementPlus.ElMessage.error("任务创建失败，请检查参数")}catch(u){console.error("保存任务失败",u),ElementPlus.ElMessage.error("保存任务失败，请稍后重试")}};return(u,o)=>{const _=Vue.__unplugin_components_0,w=Vue.__unplugin_components_1;return x.isAddVisible?(Vue.openBlock(),Vue.createElementBlock("div",{key:0,class:"modal-overlay",style:{"z-index":"99"},onClick:Vue.withModifiers(c,["self"])},[Vue.createElementVNode("div",G,[Vue.createElementVNode("div",{class:"modal-header"},[o[1]||(o[1]=Vue.createElementVNode("span",null,"添加任务",-1)),Vue.createElementVNode("button",{onClick:c},"×")]),Vue.createElementVNode("div",J,[Vue.createElementVNode("form",null,[Vue.createElementVNode("div",Q,[o[2]||(o[2]=Vue.createElementVNode("label",null,"*设备编号",-1)),Vue.createVNode(_,{modelValue:a.value.deviceId,"onUpdate:modelValue":o[0]||(o[0]=g=>a.value.deviceId=g),placeholder:"请输入设备编号",style:{width:"300px"}},null,8,["modelValue"])])])]),Vue.createElementVNode("div",X,[Vue.createVNode(w,{type:"primary",disabled:!a.value.deviceId,onClick:p},{default:Vue.withCtx(()=>o[3]||(o[3]=[Vue.createTextVNode(" 保存 ")])),_:1},8,["disabled"]),Vue.createVNode(w,{onClick:V},{default:Vue.withCtx(()=>o[4]||(o[4]=[Vue.createTextVNode(" 重置 ")])),_:1})])])])):Vue.createCommentVNode("",!0)}}},Z=I(Y,[["__scopeId","data-v-fe78fa00"]]),ee={class:"list-container"},te={class:"upper-section"},oe={class:"search-filter"},ne={class:"action-buttons"},ae={class:"lower-section"},le={class:"pagination-wrapper"},se={__name:"TaskList",setup(x){const m=Vue.ref([]),l=Vue.ref([]),c=Vue.ref(""),a=Vue.ref(1),V=Vue.ref(5),p=Vue.ref(0),u=Vue.ref([]),o=Vue.ref(!1),_=Vue.ref(!1),w=q(),g=e=>e?y(new Date(e),"yyyy-MM-dd HH:mm:ss"):"",v=async()=>{try{m.value=await b(),p.value=m.value.length,h()}catch(e){console.error("获取任务列表失败",e)}},h=()=>{const e=(a.value-1)*V.value,t=e+V.value;l.value=m.value.slice(e,t)},M=e=>{V.value=e,a.value=1,h()},B=e=>{a.value=e,h()},S=()=>{_.value=!0},D=(e,t,s)=>{w.push({name:"item-info",params:{taskId:e},query:{deviceId:t,status:s}})},$=e=>{ElementPlus.ElMessageBox.confirm(`是否确定对设备编号为 ${e.deviceId} 发起实验？`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{A(e)}).catch(()=>{})},A=async e=>{try{const s=y(new Date,"yyyy-MM-dd HH:mm:ss");await k(e.id,{deviceId:e.deviceId,startTime:s,endTime:null,status:"实验中"});const f=l.value.findIndex(i=>i.id===e.id);f!==-1&&(l.value[f].startTime=s,l.value[f].status="实验中");for(let i=0;i<e.item_count;i++){console.log(i);const r=await W(e.deviceId);console.log(r)}setTimeout(async()=>{const r=y(new Date,"yyyy-MM-dd HH:mm:ss");await k(e.id,{deviceId:e.deviceId,startTime:e.startTime,endTime:r,status:"已完成"}),await N(e.deviceId,"检测完成"),await v()},5e3)}catch(t){console.error("发起实验失败",t)}},z=e=>{u.value=e,o.value=e.length>0&&e.length<l.value.length,e.length===l.value.length&&(o.value=!1)},L=e=>{e.length===l.value.length?o.value=!1:e.length>0?o.value=!0:o.value=!1,u.value=e},P=()=>!0,T=async()=>{try{const t=(await b()).filter(s=>s.deviceId.includes(c.value));m.value=t,p.value=t.length,a.value=1,h()}catch(e){console.error("搜索任务信息失败",e)}},H=async()=>{try{for(const e of u.value)await E(e.id),await N(e.deviceId,"未检测");await v()}catch(e){console.error("批量删除任务信息失败",e)}},R=async e=>{try{await E(e.id),await N(e.deviceId,"未检测"),await v()}catch(t){console.error("删除任务信息失败",t)}},K=e=>{ElementPlus.ElMessageBox.confirm("请问您是否要删除该任务信息?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{R(e)}).catch(()=>{})};return Vue.onMounted(()=>{v()}),(e,t)=>{const s=Vue.__unplugin_components_0,f=Vue.__unplugin_components_1,i=Vue.__unplugin_components_2,r=Vue.__unplugin_components_3,d=Vue.__unplugin_components_4,j=Vue.__unplugin_components_5,U=Vue.__unplugin_components_6;return Vue.openBlock(),Vue.createElementBlock("div",ee,[Vue.createVNode(f,{separator:"/",class:"breadcrumb"},{default:Vue.withCtx(()=>[Vue.createVNode(s,null,{default:Vue.withCtx(()=>t[2]||(t[2]=[Vue.createTextVNode("首页")])),_:1}),Vue.createVNode(s,null,{default:Vue.withCtx(()=>t[3]||(t[3]=[Vue.createTextVNode("实验任务管理")])),_:1}),Vue.createVNode(s,null,{default:Vue.withCtx(()=>t[4]||(t[4]=[Vue.createTextVNode("任务管理")])),_:1})]),_:1}),Vue.createElementVNode("div",te,[Vue.createElementVNode("div",oe,[Vue.createVNode(i,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=n=>c.value=n),placeholder:"请输入设备编号",style:{width:"250px",margin:"10px 0"},onKeyup:Vue.withKeys(T,["enter"])},null,8,["modelValue"]),Vue.createVNode(r,{type:"primary",onClick:T},{default:Vue.withCtx(()=>t[5]||(t[5]=[Vue.createTextVNode(" 搜索 ")])),_:1})]),Vue.createElementVNode("div",ne,[Vue.createVNode(r,{type:"danger",onClick:H},{default:Vue.withCtx(()=>t[6]||(t[6]=[Vue.createTextVNode(" 批量删除 ")])),_:1}),Vue.createVNode(r,{type:"warning",onClick:S},{default:Vue.withCtx(()=>t[7]||(t[7]=[Vue.createTextVNode(" 添加任务 ")])),_:1})])]),t[11]||(t[11]=Vue.createElementVNode("br",null,null,-1)),Vue.createElementVNode("div",ae,[Vue.createVNode(j,{data:l.value,border:"",style:{width:"100%","margin-top":"20px"},"cell-style":{textAlign:"center"},"header-cell-style":{textAlign:"center"},onSelectionChange:z},{default:Vue.withCtx(()=>[Vue.createVNode(d,{type:"selection",width:"50",indeterminate:o.value,selectable:P,onSelectAll:L},null,8,["indeterminate"]),Vue.createVNode(d,{prop:"id",label:"任务ID",width:"100"}),Vue.createVNode(d,{prop:"deviceId",label:"设备编号",width:"100"}),Vue.createVNode(d,{prop:"status",label:"实验状态",width:"100"}),Vue.createVNode(d,{prop:"startTime",label:"开始时间",width:"200"},{default:Vue.withCtx(n=>[Vue.createTextVNode(Vue.toDisplayString(n.row.startTime?g(n.row.startTime):""),1)]),_:1}),Vue.createVNode(d,{prop:"endTime",label:"结束时间",width:"200"},{default:Vue.withCtx(n=>[Vue.createTextVNode(Vue.toDisplayString(n.row.endTime?g(n.row.endTime):""),1)]),_:1}),Vue.createVNode(d,{prop:"item_count",label:"实验项目数量",width:"200"}),Vue.createVNode(d,{label:"操作",fixed:"right","min-width":"400"},{default:Vue.withCtx(n=>[Vue.createVNode(r,{type:"primary",onClick:C=>D(n.row.id,n.row.deviceId,n.row.status)},{default:Vue.withCtx(()=>t[8]||(t[8]=[Vue.createTextVNode(" 实验项目管理 ")])),_:2},1032,["onClick"]),Vue.createVNode(r,{type:"warning",disabled:n.row.status==="已完成"||n.row.item_count===0,onClick:C=>$(n.row)},{default:Vue.withCtx(()=>t[9]||(t[9]=[Vue.createTextVNode(" 发起实验 ")])),_:2},1032,["disabled","onClick"]),Vue.createVNode(r,{type:"danger",onClick:C=>K(n.row)},{default:Vue.withCtx(()=>t[10]||(t[10]=[Vue.createTextVNode(" 删除任务 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),Vue.createElementVNode("div",le,[Vue.createVNode(U,{"current-page":a.value,"page-sizes":[5,10,15],"page-size":V.value,layout:"total, prev, pager, next, sizes, jumper",total:p.value,onSizeChange:M,onCurrentChange:B},null,8,["current-page","page-size","total"])])]),Vue.createVNode(Z,{"is-add-visible":_.value,onClose:t[1]||(t[1]=n=>_.value=!1),onRefresh:v},null,8,["is-add-visible"])])}}},de=I(se,[["__scopeId","data-v-22fba84a"]]);export{de as default};
