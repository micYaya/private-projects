import{e as m,c as H,y as ae,o as R,g as o,a,m as N,w as n,q as i,p as K,k as se,s as x,G as le,U as ne,V as oe,W as ie,X as re,u as de,Y as ue,_ as ce,t as $,R as E,L as A}from"./vue-core-DCzY6I57.js";import{_ as U,c as me,h as ve,i as D,j as z,u as V,k as L,p as pe}from"./index-B3wBei7D.js";const fe={class:"modal"},_e={class:"modal-content"},ye={class:"form-item"},we={class:"modal-footer"},ge={__name:"AddTask",props:{isAddVisible:{type:Boolean,default:!1}},emits:["close","refresh"],setup(B,{emit:w}){const d=w,_=()=>{d("close")},r=m({deviceId:"",startTime:null,endTime:null,status:"未开始"}),y=()=>{r.value={deviceId:"",startTime:null,endTime:null,status:"未开始"}},g=async()=>{try{const v=await me(r.value.deviceId);if(v.error){x.error(v.error);return}const s=await ve(r.value);s&&!s.error?(x.success("任务创建成功"),y(),_(),d("refresh")):x.error("任务创建失败，请检查参数")}catch(v){console.error("保存任务失败",v),x.error("保存任务失败，请稍后重试")}};return(v,s)=>{const T=N,k=K;return B.isAddVisible?(R(),H("div",{key:0,class:"modal-overlay",style:{"z-index":"99"},onClick:se(_,["self"])},[o("div",fe,[o("div",{class:"modal-header"},[s[1]||(s[1]=o("span",null,"添加任务",-1)),o("button",{onClick:_},"×")]),o("div",_e,[o("form",null,[o("div",ye,[s[2]||(s[2]=o("label",null,"*设备编号",-1)),a(T,{modelValue:r.value.deviceId,"onUpdate:modelValue":s[0]||(s[0]=I=>r.value.deviceId=I),placeholder:"请输入设备编号",style:{width:"300px"}},null,8,["modelValue"])])])]),o("div",we,[a(k,{type:"primary",disabled:!r.value.deviceId,onClick:g},{default:n(()=>s[3]||(s[3]=[i(" 保存 ")])),_:1},8,["disabled"]),a(k,{onClick:y},{default:n(()=>s[4]||(s[4]=[i(" 重置 ")])),_:1})])])])):ae("",!0)}}},Te=U(ge,[["__scopeId","data-v-fe78fa00"]]),be={class:"list-container"},he={class:"upper-section"},ke={class:"search-filter"},Ie={class:"action-buttons"},Ce={class:"lower-section"},xe={class:"pagination-wrapper"},Ee={__name:"TaskList",setup(B){const w=m([]),d=m([]),_=m(""),r=m(1),y=m(5),g=m(0),v=m([]),s=m(!1),T=m(!1),k=de(),I=e=>e?E(new Date(e),"yyyy-MM-dd HH:mm:ss"):"",b=async()=>{try{w.value=await D(),g.value=w.value.length,C()}catch(e){console.error("获取任务列表失败",e)}},C=()=>{const e=(r.value-1)*y.value,t=e+y.value;d.value=w.value.slice(e,t)},j=e=>{y.value=e,r.value=1,C()},q=e=>{r.value=e,C()},P=()=>{T.value=!0},W=(e,t,u)=>{k.push({name:"item-info",params:{taskId:e},query:{deviceId:t,status:u}})},F=e=>{A.confirm(`是否确定对设备编号为 ${e.deviceId} 发起实验？`,"提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then(()=>{G(e)}).catch(()=>{})},G=async e=>{try{const u=E(new Date,"yyyy-MM-dd HH:mm:ss");await L(e.id,{deviceId:e.deviceId,startTime:u,endTime:null,status:"实验中"});const h=d.value.findIndex(p=>p.id===e.id);h!==-1&&(d.value[h].startTime=u,d.value[h].status="实验中");for(let p=0;p<e.item_count;p++){console.log(p);const c=await pe(e.deviceId);console.log(c)}setTimeout(async()=>{const c=E(new Date,"yyyy-MM-dd HH:mm:ss");await L(e.id,{deviceId:e.deviceId,startTime:e.startTime,endTime:c,status:"已完成"}),await V(e.deviceId,"检测完成"),await b()},5e3)}catch(t){console.error("发起实验失败",t)}},O=e=>{v.value=e,s.value=e.length>0&&e.length<d.value.length,e.length===d.value.length&&(s.value=!1)},X=e=>{e.length===d.value.length?s.value=!1:e.length>0?s.value=!0:s.value=!1,v.value=e},Y=()=>!0,M=async()=>{try{const t=(await D()).filter(u=>u.deviceId.includes(_.value));w.value=t,g.value=t.length,r.value=1,C()}catch(e){console.error("搜索任务信息失败",e)}},J=async()=>{try{for(const e of v.value)await z(e.id),await V(e.deviceId,"未检测");await b()}catch(e){console.error("批量删除任务信息失败",e)}},Q=async e=>{try{await z(e.id),await V(e.deviceId,"未检测"),await b()}catch(t){console.error("删除任务信息失败",t)}},Z=e=>{A.confirm("请问您是否要删除该任务信息?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Q(e)}).catch(()=>{})};return le(()=>{b()}),(e,t)=>{const u=ue,h=oe,p=N,c=K,f=ce,ee=ie,te=re;return R(),H("div",be,[a(h,{separator:"/",class:"breadcrumb"},{default:n(()=>[a(u,null,{default:n(()=>t[2]||(t[2]=[i("首页")])),_:1}),a(u,null,{default:n(()=>t[3]||(t[3]=[i("实验任务管理")])),_:1}),a(u,null,{default:n(()=>t[4]||(t[4]=[i("任务管理")])),_:1})]),_:1}),o("div",he,[o("div",ke,[a(p,{modelValue:_.value,"onUpdate:modelValue":t[0]||(t[0]=l=>_.value=l),placeholder:"请输入设备编号",style:{width:"250px",margin:"10px 0"},onKeyup:ne(M,["enter"])},null,8,["modelValue"]),a(c,{type:"primary",onClick:M},{default:n(()=>t[5]||(t[5]=[i(" 搜索 ")])),_:1})]),o("div",Ie,[a(c,{type:"danger",onClick:J},{default:n(()=>t[6]||(t[6]=[i(" 批量删除 ")])),_:1}),a(c,{type:"warning",onClick:P},{default:n(()=>t[7]||(t[7]=[i(" 添加任务 ")])),_:1})])]),t[11]||(t[11]=o("br",null,null,-1)),o("div",Ce,[a(ee,{data:d.value,border:"",style:{width:"100%","margin-top":"20px"},"cell-style":{textAlign:"center"},"header-cell-style":{textAlign:"center"},onSelectionChange:O},{default:n(()=>[a(f,{type:"selection",width:"50",indeterminate:s.value,selectable:Y,onSelectAll:X},null,8,["indeterminate"]),a(f,{prop:"id",label:"任务ID",width:"100"}),a(f,{prop:"deviceId",label:"设备编号",width:"100"}),a(f,{prop:"status",label:"实验状态",width:"100"}),a(f,{prop:"startTime",label:"开始时间",width:"200"},{default:n(l=>[i($(l.row.startTime?I(l.row.startTime):""),1)]),_:1}),a(f,{prop:"endTime",label:"结束时间",width:"200"},{default:n(l=>[i($(l.row.endTime?I(l.row.endTime):""),1)]),_:1}),a(f,{prop:"item_count",label:"实验项目数量",width:"200"}),a(f,{label:"操作",fixed:"right","min-width":"400"},{default:n(l=>[a(c,{type:"primary",onClick:S=>W(l.row.id,l.row.deviceId,l.row.status)},{default:n(()=>t[8]||(t[8]=[i(" 实验项目管理 ")])),_:2},1032,["onClick"]),a(c,{type:"warning",disabled:l.row.status==="已完成"||l.row.item_count===0,onClick:S=>F(l.row)},{default:n(()=>t[9]||(t[9]=[i(" 发起实验 ")])),_:2},1032,["disabled","onClick"]),a(c,{type:"danger",onClick:S=>Z(l.row)},{default:n(()=>t[10]||(t[10]=[i(" 删除任务 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),o("div",xe,[a(te,{"current-page":r.value,"page-sizes":[5,10,15],"page-size":y.value,layout:"total, prev, pager, next, sizes, jumper",total:g.value,onSizeChange:j,onCurrentChange:q},null,8,["current-page","page-size","total"])])]),a(Te,{"is-add-visible":T.value,onClose:t[1]||(t[1]=l=>T.value=!1),onRefresh:b},null,8,["is-add-visible"])])}}},Me=U(Ee,[["__scopeId","data-v-22fba84a"]]);export{Me as default};
